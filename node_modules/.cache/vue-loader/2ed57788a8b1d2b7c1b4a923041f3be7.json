{"remainingRequest":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\index.js??ref--1-1!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue?vue&type=style&index=0&id=c1f1971a&scoped=true&lang=css","dependencies":[{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue","mtime":1661155244000},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\css-loader\\dist\\cjs.js","mtime":1739441792526},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\stylePostLoader.js","mtime":1739441801688},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\postcss-loader\\src\\index.js","mtime":1739441795912},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1739441789589},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\index.js","mtime":1739441797509}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CiNsb2FkaW5nLXdpbmRvdyB7CiAgZGlzcGxheTogZmxleDsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgd2lkdGg6IDEwMCU7CiAgaGVpZ2h0OiAxMDAlOwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgei1pbmRleDogOTk5OTsKfQouZmFkZS1lbnRlci1hY3RpdmUsCi5mYWRlLWxlYXZlLWFjdGl2ZSB7CiAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjVzIGVhc2U7Cn0KCi5mYWRlLWVudGVyLWZyb20sCi5mYWRlLWxlYXZlLXRvIHsKICBvcGFjaXR5OiAwOwp9Ci5jb250ZW50IHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjYjBkMmZmOwp9Ci5hbGVydC1mYWRlLWVudGVyLWFjdGl2ZSwKLmFsZXJ0LWZhZGUtbGVhdmUtYWN0aXZlIHsKICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMnMgZWFzZTsKfQoKLmFsZXJ0LWZhZGUtZW50ZXItZnJvbSwKLmFsZXJ0LWZhZGUtbGVhdmUtdG8gewogIG9wYWNpdHk6IDA7Cn0KI2FsZXJ0LXdyYXBwZXJ7CiAgd2lkdGg6IDEwMCU7CiAgbWF4LWhlaWdodDogODAlOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDU1cHg7CiAgZGlzcGxheTogZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICBvdmVyZmxvdzogaGlkZGVuOwogIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CiNuZXctbWVzc2FnZS1idXR0b24td3JhcHBlciB7CiAgcG9zaXRpb246IGFic29sdXRlOwogIGJvdHRvbTogNTVweDsKICBkaXNwbGF5OiBmbGV4OwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KI25ldy1tZXNzYWdlLWJ1dHRvbi13cmFwcGVyIGJ1dHRvbiB7CiAgY29sb3I6ICNmZmZmZmY7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDAwMDk5OwogIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cg=="},{"version":3,"sources":["C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue"],"names":[],"mappings":"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","file":"C:/Users/m.ebisu/Desktop/zl_connect/src/views/Main.vue","sourceRoot":"","sourcesContent":["<template>\n<transition name=\"fade\">\n  <div v-if=\"!isLoaded\" id=\"loading-window\">\n    <LoadingSpinner/>\n  </div>\n</transition>\n<div class=\"main h-100 w-100 d-flex flex-column\">\n  <Header ref=\"header\" :block_status=\"block_status\" :reload=\"getNewLINEChatData\" :supportNotification=\"supportNotification\" :toggleAutoReload=\"toggleAutoReload\" :setBlockFlg=\"setBlockFlg\" :getBlockFlg=\"getBlockFlg\"></Header>\n  <div class=\"content d-flex flex-column flex-fill border-top border-bottom overflow-auto\" :class=\"terminal\" @scroll=\"handleScroll\">\n    <div :class=\"{'d-none': chatLogs.length == 0}\">\n      <button class=\"btn btn-outline-accent mt-2\" @click=\"getOldLINEChatData\">過去チャットの取得</button>\n    </div>\n    <Balloon\n      ref=\"content\"\n      v-for=\"chat in chatLogs\"\n      v-bind:key=\"chat.chatId\"\n      :chatId=\"chat.chatId\"\n      :type=\"chat.type\"\n      :speaker=\"chat.speaker\"\n      :message=\"chat.message\"\n      :url=\"chat.url\"\n      :timestamp=\"chat.timestamp\"\n      :isFirstLoad=\"chat.isFirstLoad\"\n      :isViewDate=\"chat.isViewDate\"\n      :contentScroll=\"contentScroll\"\n      :openPreview=\"openPreview\"></Balloon>\n  </div>\n  <Footer :sendChat=\"sendChat\"></Footer>\n  <Preview v-show=\"previewInfo.isShow\" :closePreview=\"closePreview\" :class=\"terminal\" :type=\"previewInfo.tag\" :src=\"previewInfo.src\" />\n  <!-- アラート表示 -->\n  <div id=\"alert-wrapper\">\n    <transition-group name=\"alert-fade\" tag=\"Alert\" class=\"w-75\">\n      <div v-for=\"(alertConfig, index) in alertList\" :key=\"index\" class=\"w-100\">\n        <Alert :class=\"index\" :type=\"alertConfig.type\" :msg=\"alertConfig.msg\" />\n      </div>\n    </transition-group>\n  </div>\n  <!-- 新規メッセージ通知 -->\n  <div v-if=\"newMessageCount > 0\" id=\"new-message-button-wrapper\">\n    <button class=\"btn btn-sm\" @click=\"scrollBottom\">{{ newMessageCount }}件の新規メッセージ</button>\n  </div>\n</div>\n</template>\n\n<script>\nimport { ref, reactive, onMounted, onBeforeUnmount, watchEffect } from 'vue';\nimport { useRouter } from 'vue-router';\n\nimport ZohoLINE from '../lib/ZohoLINE.js';\n\nimport Header from '../components/Header.vue';\nimport Balloon from '../components/Balloon.vue';\nimport Footer from '../components/Footer.vue';\n\nimport Preview from '../components/Preview.vue';\nimport LoadingSpinner from '../components/LoadingSpinner.vue';\nimport Alert from '../components/Alert.vue';\n\nimport dayjs from 'dayjs';\nimport 'dayjs/locale/ja';\ndayjs.locale('ja');\n\nexport default {\n  name: 'Main',\n  components: {\n    Header,\n    Balloon,\n    Footer,\n    LoadingSpinner,\n    Preview,\n    Alert\n  },\n  setup() {\n    console.log(\"setup\");\n    const USER_TYPE_OBJ = {\n      0: \"right\",\n      1: \"left\"\n    };\n    const CHAT_TYPE_OBJ = {\n      0: \"text\",\n      1: \"sticker\",     // スタンプ\n      2: \"image\",       // 画像\n      3: \"video\",       // 動画\n      4: \"audio\",       // 音声\n      5: \"application\"  // PDF\n    };\n    const AUTO_RELOAD_INTERVAL = 1 * 1000;\n    // ZohoLINEクラス\n    let ZLC = null;\n    // Zohoプラグイン\n    const ZOHO = window.ZOHO;\n    // vue-router\n    const router = useRouter();\n    // 読み込みフラグ\n    const isLoaded = ref(false);\n    // Zoho CRMログインユーザーデータ\n    const currentUser = ref(\"\");\n    // Zohoレコードデータ\n    const lineUserData = ref(\"\");\n    // 顧客ID\n    const lineUserId = ref(\"\");\n    // LINEチャットログ\n    const chatLogs = ref([]);\n    //LINE既読時間\n    const last_read_time = ref(\"0\");\n    //取得した一番古いLINEチャットの時間\n    const oldest_chat_time = ref(dayjs().format(\"YYYY-MM-DD HH:mm:ss.SSS\"));\n    // ZohoLINEの契約企業ID\n    const companyId = ref('');\n    // ZohoLINEのチャンネルID\n    const channelId = ref('');\n    // ZohoLINEのAPIキー\n    const apiKey = ref('');\n    //ヘッダーのDOM\n    const header = ref(null);\n    //チャット表示エリアのDOM\n    const content = ref(null);\n    //チャット表示エリアのスクロール位置\n    const contentScrollPosition = ref(null);\n    //スクロール位置が一番下であるか\n    const isBottomScrollPosition = ref(null);\n    // 最初のチャットデータ取得フラグ\n    const isFirstGetChatData = ref(true);\n    // 自動更新を行うsetIntervalのID\n    const autoReloadId = ref(null);\n    // 自動更新の自動停止時間(自動更新開始から６時間後に自動停止) dayjsオブジェクト\n    const autoReloadLimitTime = ref(null);\n    // 端末の識別用変数\n    const terminal = ref(\"pc\");\n    // アラート表示用変数\n    const alertList = ref([]);\n    // コンテンツプレビュー用変数\n    const previewInfo = reactive({\n      isShow: false,\n      tag: \"img\",\n      src: \"\"\n    });\n    // 新規メッセージ未表示件数\n    const newMessageCount = ref(0);\n    // ブロックフラグ\n    const block_status = ref(false);\n\n    watchEffect(\n      () => {\n        contentScroll();\n      },\n      {\n        flush: 'post'\n      }\n    );\n\n    onMounted(async () => {\n      console.log(\"onMounted\");\n      const appElement = document.getElementById(\"app\");\n      getTerminal();\n      window.addEventListener('resize', getTerminal);\n      //Zohoプラグインの初期化完了時\n      ZOHO.embeddedApp.on(\"PageLoad\", (data) => {\n        appElement.classList.add('loaded');\n        appElement.dataset.entity = data.Entity;\n        appElement.dataset.entityId = data.EntityId;\n        // ZohoLINEの必要なデータの取得\n        initialize(data);\n      });\n      //Zohoプラグインの初期化\n      ZOHO.embeddedApp.init();\n      if(appElement.classList.contains('loaded')){\n        initialize({\n          Entity: appElement.dataset.entity,\n          EntityId: appElement.dataset.entityId\n        });\n      }\n    });\n\n    onBeforeUnmount(() => {\n      console.log(\"onBeforeUnmount\")\n      if(autoReloadId.value != null){\n        clearTimeout(autoReloadId.value);\n        autoReloadId.value = null;\n      }\n      window.removeEventListener('resize', getTerminal);\n    });\n\n    const initialize = async (data) => {\n      try {\n        isFirstGetChatData.value = true;\n        //LINEユーザーデータの取得\n        lineUserData.value = await getZohoCustomerId(data.Entity, data.EntityId);\n        lineUserId.value = lineUserData.value.LINE_ID;\n        // ZohoLINEのAPIキーの取得\n        const zohoLineConfig = await getZohoCRMVariables({apiKeys:[\"zoho_line_api_key\", \"zoho_line_company_id\", \"zoho_line_channel_id\"]});\n        if(zohoLineConfig.zoho_line_company_id.value){\n          companyId.value = zohoLineConfig.zoho_line_company_id.value;\n        }else{\n          throw new Error(\"契約企業IDが見つかりませんでした\");\n        }\n        if(zohoLineConfig.zoho_line_api_key.value){\n          apiKey.value = zohoLineConfig.zoho_line_api_key.value;\n        }else{\n          throw new Error(\"ZohoLINE APIキーが見つかりませんでした\");\n        }\n        if(zohoLineConfig.zoho_line_channel_id.value){\n          channelId.value = zohoLineConfig.zoho_line_channel_id.value;\n        }else{\n          throw new Error(\"ZohoLINE チャンネルIDが見つかりませんでした\");\n        }\n        ZLC = new ZohoLINE(companyId.value, channelId.value, apiKey.value);\n        // ブロックステータスの取得\n        const userData = await ZLC.getBlockFlg(lineUserId.value);\n        block_status.value = userData.block_status;\n        console.log(\"ブロックステータス：\",block_status.value);\n        currentUser.value = await getCurrentUser();\n        await supportNotification(\"start\");\n        toggleAutoReload(false);\n        toggleAutoReload(true);\n        isLoaded.value = true;\n      } catch (err) {\n        console.error(err);\n        router.push({name: 'Error', params: { message: err.message }});\n      }\n    };\n\n    const sendChat = async (message, type, file=null) => {\n      // メッセージ送信\n      if (type == \"text\") {\n        await ZLC.sendChat(lineUserId.value, message).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"メッセージの送信に失敗しました\");\n          }\n        });\n      // スタンプ送信\n      }else if(type == \"sticker\"){\n        await ZLC.sendStickerChat(lineUserId.value, message).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"スタンプの送信に失敗しました\");\n          }\n        });\n      // 画像送信\n      }else if(type == \"image\"){\n        await ZLC.sendImageChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"画像の送信に失敗しました\");\n          }\n        });\n      // 動画送信\n      }else if(type == \"video\"){\n        await ZLC.sendVideoChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"動画の送信に失敗しました\");\n          }\n        });\n      // 音声送信\n      }else if(type == \"audio\"){\n        await ZLC.sendAudioChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"音声の送信に失敗しました\");\n          }\n        });\n      // PDF送信\n      }else if(type == \"application\"){\n        await ZLC.sendPdfChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"PDFの送信に失敗しました\");\n          }\n        });\n      }\n      isBottomScrollPosition.value = null;\n      // await getNewLINEChatData();\n    };\n\n    // LINE連携済みの顧客IDの取得\n    const getZohoCustomerId = (entity, recordId) => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.API.getRecord({\n          Entity: entity,\n          RecordID: recordId\n        }).then((response) => {\n          // console.log(response);\n          if (response.data && response.data[0]) {\n            resolve(response.data[0]);\n          } else {\n            reject();\n          }\n        }).catch((err) => {\n          reject(err);\n        });\n      });\n    };\n\n    //CRMの変数からZohoLINEのAPIキーを取得\n    const getZohoCRMVariables = (apiName) => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.API.getOrgVariable(apiName).then((response) => {\n          console.log(response);\n          if (response.Success) {\n            resolve(response.Success.Content);\n          } else {\n            reject(response);\n          }\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    // ログインユーザーデータの取得\n    const getCurrentUser = () => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.CONFIG.getCurrentUser().then((response) => {\n          try{\n            resolve(response.users[0]);\n          }catch(err){\n            console.error(err);\n            reject(err);\n          }\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    const supportNotification = (type) => {\n      return new Promise((resolve, reject) => {\n        const functionName = \"supportnotification\";\n        const requestData = {\n          arguments: JSON.stringify({\n            type: type,\n            currentUserName: currentUser.value.full_name,\n            contactName: lineUserData.value.Full_Name,\n            contactId: lineUserData.value.id\n          })\n        };\n        ZOHO.CRM.FUNCTIONS.execute(functionName, requestData).then(function(response){\n          resolve(response);\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    // LINEチャットデータの取得\n    const getLINEChatData = async () => {\n      const lineChatData = await ZLC.getChat(lineUserId.value);\n      // console.log(lineChatData)\n      let lineChatArray = [];\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 1){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n\n        lineChatArray.push({\n          chatId: chat.chat_id,\n          speaker: USER_TYPE_OBJ[chat.user_type],\n          type: CHAT_TYPE_OBJ[chat.chat_type],\n          message: chat.text,\n          // url: chat.media_url ? ZLC.getMediaURL(chat.media_url) : null,\n          // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n          url: url,\n          timestamp: chat.sent_at,\n          isFirstLoad: true\n        });\n        console.log(\"LINE取得\");\n        console.log(chat.sent_at);\n        updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n    };\n    // 新規LINEチャットデータの取得\n    const getNewLINEChatData = async () => {\n      const lineChatData = await ZLC.getNewChat(lineUserId.value, last_read_time.value);\n      let lineChatArray = chatLogs.value;\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 1){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n          lineChatArray.push({\n            chatId: chat.chat_id,\n            speaker: USER_TYPE_OBJ[chat.user_type],\n            type: CHAT_TYPE_OBJ[chat.chat_type],\n            message: chat.text,\n            // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n            url: url,\n            timestamp: chat.sent_at,\n            isFirstLoad: false\n          });\n          console.log(\"新規LINE取得\");\n          console.log(chat.sent_at);\n          updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n      if(isBottomScrollPosition.value === false){\n        newMessageCount.value = newMessageCount.value + lineChatData.chats.length;\n      }else{\n        newMessageCount.value = 0;\n      }\n    };\n    // 過去LINEチャットデータの取得\n    const getOldLINEChatData = async () => {\n      // チャット取得前のチャット表示エリアの高さを保存\n      contentScrollPosition.value = content.value.$el.parentElement.scrollHeight;\n      // console.log(\"getOldLINEChatData\", contentScrollPosition.value)\n      const lineChatData = await ZLC.getOldChat(lineUserId.value, oldest_chat_time.value, 10);\n      let lineChatArray = chatLogs.value;\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 4){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n        lineChatArray.push({\n          chatId: chat.chat_id,\n          speaker: USER_TYPE_OBJ[chat.user_type],\n          type: CHAT_TYPE_OBJ[chat.chat_type],\n          message: chat.text,\n          // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n          url: url,\n          timestamp: chat.sent_at,\n          isFirstLoad: false\n        });\n        console.log(\"過去LINE取得\");\n        console.log(chat.sent_at);\n        updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n    };\n\n    const toggleAutoReload = (isAutoReload) => {\n      console.log(\"toggleAutoReload\");\n      if(isAutoReload && autoReloadId.value == null){\n        // 6時間後に自動更新をオフ\n        autoReloadLimitTime.value = dayjs().add(6, 'h');\n        autoReloadId.value = setInterval(async () => {\n          if(isFirstGetChatData.value){\n            isFirstGetChatData.value = false;\n            await getLINEChatData();\n          }else if(dayjs().isBefore(autoReloadLimitTime.value)){\n            await getNewLINEChatData();\n          }else{\n            header.value.stopAutoReload();\n          }\n        }, AUTO_RELOAD_INTERVAL);\n      }else if(!isAutoReload && autoReloadId.value != null){\n        clearTimeout(autoReloadId.value);\n        autoReloadId.value = null;\n        autoReloadLimitTime.value = null;\n      }\n    };\n    // チャット表示エリアのスクロールハンドル\n    const handleScroll = () => {\n      const target = content.value.$el.parentElement;\n      contentScrollPosition.value = null;\n      if(target.scrollTop + target.clientHeight  == target.scrollHeight){\n        isBottomScrollPosition.value = true;\n        newMessageCount.value = 0;\n      }else{\n        isBottomScrollPosition.value = false;\n      }\n    };\n\n    // chatLogsの更新\n    const updateChatLogs = (lineChatArray) => {\n      chatLogs.value = lineChatArray.sort((x, y) => {\n        if (x.chatId < y.chatId) return -1;\n        if (x.chatId > y.chatId) return 1;\n        return 0;\n      });\n      let sentDate = dayjs(0);\n      chatLogs.value.forEach((chatLog, i) => {\n        if(sentDate.isBefore( dayjs(chatLogs.value[i].timestamp.split(\" \")[0], \"YYYY-MM-DD\"))){\n          sentDate = dayjs(chatLogs.value[i].timestamp.split(\" \")[0], \"YYYY-MM-DD\");\n          chatLogs.value[i].isViewDate = true;\n        }else{\n          chatLogs.value[i].isViewDate = false;\n        }\n      });\n      // console.log(chatLogs)\n    };\n\n    // 新規チャット、過去チャット取得のための時間の更新\n    const updateChatReadTime = (sent_at) => {\n      if (dayjs(oldest_chat_time.value, \"YYYY-MM-DD HH:mm:ss.SSS\").isAfter(dayjs(sent_at, \"YYYY-MM-DD HH:mm:ss.SSS\"))) {\n        oldest_chat_time.value = sent_at;\n      }\n      if (dayjs(last_read_time.value, \"YYYY-MM-DD HH:mm:ss.SSS\").isBefore(dayjs(sent_at, \"YYYY-MM-DD HH:mm:ss.SSS\"))) {\n        last_read_time.value = sent_at;\n      }\n      console.log(oldest_chat_time.value)\n    };\n\n    // LINEチャット表示エリアの自動スクロール\n    // -過去のチャット読み込み時はスクロール位置固定\n    // -最新チャット読み込み時は一番下までスクロール\n    const contentScroll = (isFirstLoad=false) => {\n      if(content.value){\n        const target = content.value.$el.parentElement;\n        setTimeout(() => {\n          if(isFirstLoad){\n            target.scrollTop = target.scrollHeight;\n          }else if(contentScrollPosition.value != null){\n            target.scrollTop = target.scrollHeight - contentScrollPosition.value;\n          }else if(isBottomScrollPosition.value == null || isBottomScrollPosition.value == true){\n            target.scrollTop = target.scrollHeight;\n          }\n        }, 0);\n      }\n    };\n\n    const getTerminal = () => {\n      if(window.outerWidth > window.outerHeight){\n        terminal.value = \"pc\";\n      }else{\n        terminal.value = \"sp\"\n      }\n    };\n\n    const openPreview = (tag, src) => {\n      previewInfo.isShow = true;\n      previewInfo.tag = tag;\n      previewInfo.src = src;\n    };\n\n    const closePreview = () => {\n      previewInfo.isShow = false;\n    };\n\n    const showAlert = (type, msg) => {\n      if(type){\n        alertList.value.push({\n          type: type,\n          msg: msg\n        });\n        setTimeout(function () {\n          alertList.value.shift();\n        }, 2500);\n      }\n    };\n\n    const scrollBottom = () => {\n      if(content.value){\n        const target = content.value.$el.parentElement;\n        target.scrollTop = target.scrollHeight;\n      }\n    };\n\n    const getBlockFlg = async () => {\n      console.log(lineUserId.value);\n      return await ZLC.getBlockFlg(lineUserId.value).catch((err) => {\n          console.error(err);\n      });\n    }\n\n    const setBlockFlg = async () => {\n        console.log(lineUserId.value);\n        block_status.value = !block_status.value;\n        console.log(\"ブロックステータス：\",block_status.value);\n        await ZLC.setBlockFlg(lineUserId.value, block_status.value).catch((err) => {\n          console.error(err);\n        });\n        if(block_status.value){\n          showAlert(\"success\", \"ブロックしました。\");\n        } else {\n          showAlert(\"success\", \"ブロック解除しました。\");\n        }\n    };\n    return {\n      header,\n      content,\n      chatLogs,\n      sendChat,\n      getNewLINEChatData,\n      getOldLINEChatData,\n      toggleAutoReload,\n      contentScroll,\n      handleScroll,\n      isLoaded,\n      terminal,\n      previewInfo,\n      openPreview,\n      closePreview,\n      alertList,\n      showAlert,\n      supportNotification,\n      newMessageCount,\n      scrollBottom,\n      block_status,\n      getBlockFlg,\n      setBlockFlg\n    };\n  }\n}\n</script>\n<style scoped>\n#loading-window {\n  display: flex;\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  justify-content: center;\n  align-items: center;\n  background-color: white;\n  z-index: 9999;\n}\n.fade-enter-active,\n.fade-leave-active {\n  transition: opacity 0.5s ease;\n}\n\n.fade-enter-from,\n.fade-leave-to {\n  opacity: 0;\n}\n.content {\n  background-color: #b0d2ff;\n}\n.alert-fade-enter-active,\n.alert-fade-leave-active {\n  transition: opacity 0.2s ease;\n}\n\n.alert-fade-enter-from,\n.alert-fade-leave-to {\n  opacity: 0;\n}\n#alert-wrapper{\n  width: 100%;\n  max-height: 80%;\n  position: absolute;\n  top: 55px;\n  display: flex;\n  justify-content: center;\n  overflow: hidden;\n  pointer-events: none;\n}\n#new-message-button-wrapper {\n  position: absolute;\n  bottom: 55px;\n  display: flex;\n  justify-content: center;\n  left: 0;\n  right: 0;\n  pointer-events: none;\n}\n#new-message-button-wrapper button {\n  color: #ffffff;\n  background-color: #00000099;\n  pointer-events: auto;\n}\n</style>\n"]}]}
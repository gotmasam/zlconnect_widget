{"remainingRequest":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\thread-loader\\dist\\cjs.js!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\templateLoader.js??ref--6!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\cache-loader\\dist\\cjs.js??ref--1-0!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\index.js??ref--1-1!C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue?vue&type=template&id=191dbe34&scoped=true","dependencies":[{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue","mtime":1661155244000},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1739441789589},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\thread-loader\\dist\\cjs.js","mtime":1739441789588},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\babel-loader\\lib\\index.js","mtime":1739441795918},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\templateLoader.js","mtime":1739441802021},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1739441789589},{"path":"C:\\Users\\m.ebisu\\Desktop\\zl_connect\\node_modules\\vue-loader-v16\\dist\\index.js","mtime":1739441797509}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IHsgcmVzb2x2ZUNvbXBvbmVudCBhcyBfcmVzb2x2ZUNvbXBvbmVudCwgY3JlYXRlVk5vZGUgYXMgX2NyZWF0ZVZOb2RlLCBvcGVuQmxvY2sgYXMgX29wZW5CbG9jaywgY3JlYXRlRWxlbWVudEJsb2NrIGFzIF9jcmVhdGVFbGVtZW50QmxvY2ssIGNyZWF0ZUNvbW1lbnRWTm9kZSBhcyBfY3JlYXRlQ29tbWVudFZOb2RlLCBUcmFuc2l0aW9uIGFzIF9UcmFuc2l0aW9uLCB3aXRoQ3R4IGFzIF93aXRoQ3R4LCBjcmVhdGVFbGVtZW50Vk5vZGUgYXMgX2NyZWF0ZUVsZW1lbnRWTm9kZSwgbm9ybWFsaXplQ2xhc3MgYXMgX25vcm1hbGl6ZUNsYXNzLCByZW5kZXJMaXN0IGFzIF9yZW5kZXJMaXN0LCBGcmFnbWVudCBhcyBfRnJhZ21lbnQsIGNyZWF0ZUJsb2NrIGFzIF9jcmVhdGVCbG9jaywgdlNob3cgYXMgX3ZTaG93LCB3aXRoRGlyZWN0aXZlcyBhcyBfd2l0aERpcmVjdGl2ZXMsIFRyYW5zaXRpb25Hcm91cCBhcyBfVHJhbnNpdGlvbkdyb3VwLCB0b0Rpc3BsYXlTdHJpbmcgYXMgX3RvRGlzcGxheVN0cmluZyB9IGZyb20gInZ1ZSI7CmNvbnN0IF9ob2lzdGVkXzEgPSB7CiAga2V5OiAwLAogIGlkOiAibG9hZGluZy13aW5kb3ciCn07CmNvbnN0IF9ob2lzdGVkXzIgPSB7CiAgY2xhc3M6ICJtYWluIGgtMTAwIHctMTAwIGQtZmxleCBmbGV4LWNvbHVtbiIKfTsKY29uc3QgX2hvaXN0ZWRfMyA9IHsKICBpZDogImFsZXJ0LXdyYXBwZXIiCn07CmNvbnN0IF9ob2lzdGVkXzQgPSB7CiAga2V5OiAwLAogIGlkOiAibmV3LW1lc3NhZ2UtYnV0dG9uLXdyYXBwZXIiCn07CmV4cG9ydCBmdW5jdGlvbiByZW5kZXIoX2N0eCwgX2NhY2hlLCAkcHJvcHMsICRzZXR1cCwgJGRhdGEsICRvcHRpb25zKSB7CiAgY29uc3QgX2NvbXBvbmVudF9Mb2FkaW5nU3Bpbm5lciA9IF9yZXNvbHZlQ29tcG9uZW50KCJMb2FkaW5nU3Bpbm5lciIpOwogIGNvbnN0IF9jb21wb25lbnRfSGVhZGVyID0gX3Jlc29sdmVDb21wb25lbnQoIkhlYWRlciIpOwogIGNvbnN0IF9jb21wb25lbnRfQmFsbG9vbiA9IF9yZXNvbHZlQ29tcG9uZW50KCJCYWxsb29uIik7CiAgY29uc3QgX2NvbXBvbmVudF9Gb290ZXIgPSBfcmVzb2x2ZUNvbXBvbmVudCgiRm9vdGVyIik7CiAgY29uc3QgX2NvbXBvbmVudF9QcmV2aWV3ID0gX3Jlc29sdmVDb21wb25lbnQoIlByZXZpZXciKTsKICBjb25zdCBfY29tcG9uZW50X0FsZXJ0ID0gX3Jlc29sdmVDb21wb25lbnQoIkFsZXJ0Iik7CiAgcmV0dXJuIF9vcGVuQmxvY2soKSwgX2NyZWF0ZUVsZW1lbnRCbG9jayhfRnJhZ21lbnQsIG51bGwsIFtfY3JlYXRlVk5vZGUoX1RyYW5zaXRpb24sIHsKICAgIG5hbWU6ICJmYWRlIgogIH0sIHsKICAgIGRlZmF1bHQ6IF93aXRoQ3R4KCgpID0+IFshJHNldHVwLmlzTG9hZGVkID8gKF9vcGVuQmxvY2soKSwgX2NyZWF0ZUVsZW1lbnRCbG9jaygiZGl2IiwgX2hvaXN0ZWRfMSwgW19jcmVhdGVWTm9kZShfY29tcG9uZW50X0xvYWRpbmdTcGlubmVyKV0pKSA6IF9jcmVhdGVDb21tZW50Vk5vZGUoIiIsIHRydWUpXSksCiAgICBfOiAxCiAgfSksIF9jcmVhdGVFbGVtZW50Vk5vZGUoImRpdiIsIF9ob2lzdGVkXzIsIFtfY3JlYXRlVk5vZGUoX2NvbXBvbmVudF9IZWFkZXIsIHsKICAgIHJlZjogImhlYWRlciIsCiAgICBibG9ja19zdGF0dXM6ICRzZXR1cC5ibG9ja19zdGF0dXMsCiAgICByZWxvYWQ6ICRzZXR1cC5nZXROZXdMSU5FQ2hhdERhdGEsCiAgICBzdXBwb3J0Tm90aWZpY2F0aW9uOiAkc2V0dXAuc3VwcG9ydE5vdGlmaWNhdGlvbiwKICAgIHRvZ2dsZUF1dG9SZWxvYWQ6ICRzZXR1cC50b2dnbGVBdXRvUmVsb2FkLAogICAgc2V0QmxvY2tGbGc6ICRzZXR1cC5zZXRCbG9ja0ZsZywKICAgIGdldEJsb2NrRmxnOiAkc2V0dXAuZ2V0QmxvY2tGbGcKICB9LCBudWxsLCA4LCBbImJsb2NrX3N0YXR1cyIsICJyZWxvYWQiLCAic3VwcG9ydE5vdGlmaWNhdGlvbiIsICJ0b2dnbGVBdXRvUmVsb2FkIiwgInNldEJsb2NrRmxnIiwgImdldEJsb2NrRmxnIl0pLCBfY3JlYXRlRWxlbWVudFZOb2RlKCJkaXYiLCB7CiAgICBjbGFzczogX25vcm1hbGl6ZUNsYXNzKFsiY29udGVudCBkLWZsZXggZmxleC1jb2x1bW4gZmxleC1maWxsIGJvcmRlci10b3AgYm9yZGVyLWJvdHRvbSBvdmVyZmxvdy1hdXRvIiwgJHNldHVwLnRlcm1pbmFsXSksCiAgICBvblNjcm9sbDogX2NhY2hlWzFdIHx8IChfY2FjaGVbMV0gPSAoLi4uYXJncykgPT4gJHNldHVwLmhhbmRsZVNjcm9sbCAmJiAkc2V0dXAuaGFuZGxlU2Nyb2xsKC4uLmFyZ3MpKQogIH0sIFtfY3JlYXRlRWxlbWVudFZOb2RlKCJkaXYiLCB7CiAgICBjbGFzczogX25vcm1hbGl6ZUNsYXNzKHsKICAgICAgJ2Qtbm9uZSc6ICRzZXR1cC5jaGF0TG9ncy5sZW5ndGggPT0gMAogICAgfSkKICB9LCBbX2NyZWF0ZUVsZW1lbnRWTm9kZSgiYnV0dG9uIiwgewogICAgY2xhc3M6ICJidG4gYnRuLW91dGxpbmUtYWNjZW50IG10LTIiLAogICAgb25DbGljazogX2NhY2hlWzBdIHx8IChfY2FjaGVbMF0gPSAoLi4uYXJncykgPT4gJHNldHVwLmdldE9sZExJTkVDaGF0RGF0YSAmJiAkc2V0dXAuZ2V0T2xkTElORUNoYXREYXRhKC4uLmFyZ3MpKQogIH0sICLpgY7ljrvjg4Hjg6Pjg4Pjg4jjga7lj5blvpciKV0sIDIpLCAoX29wZW5CbG9jayh0cnVlKSwgX2NyZWF0ZUVsZW1lbnRCbG9jayhfRnJhZ21lbnQsIG51bGwsIF9yZW5kZXJMaXN0KCRzZXR1cC5jaGF0TG9ncywgY2hhdCA9PiB7CiAgICByZXR1cm4gX29wZW5CbG9jaygpLCBfY3JlYXRlQmxvY2soX2NvbXBvbmVudF9CYWxsb29uLCB7CiAgICAgIHJlZl9mb3I6IHRydWUsCiAgICAgIHJlZjogImNvbnRlbnQiLAogICAgICBrZXk6IGNoYXQuY2hhdElkLAogICAgICBjaGF0SWQ6IGNoYXQuY2hhdElkLAogICAgICB0eXBlOiBjaGF0LnR5cGUsCiAgICAgIHNwZWFrZXI6IGNoYXQuc3BlYWtlciwKICAgICAgbWVzc2FnZTogY2hhdC5tZXNzYWdlLAogICAgICB1cmw6IGNoYXQudXJsLAogICAgICB0aW1lc3RhbXA6IGNoYXQudGltZXN0YW1wLAogICAgICBpc0ZpcnN0TG9hZDogY2hhdC5pc0ZpcnN0TG9hZCwKICAgICAgaXNWaWV3RGF0ZTogY2hhdC5pc1ZpZXdEYXRlLAogICAgICBjb250ZW50U2Nyb2xsOiAkc2V0dXAuY29udGVudFNjcm9sbCwKICAgICAgb3BlblByZXZpZXc6ICRzZXR1cC5vcGVuUHJldmlldwogICAgfSwgbnVsbCwgOCwgWyJjaGF0SWQiLCAidHlwZSIsICJzcGVha2VyIiwgIm1lc3NhZ2UiLCAidXJsIiwgInRpbWVzdGFtcCIsICJpc0ZpcnN0TG9hZCIsICJpc1ZpZXdEYXRlIiwgImNvbnRlbnRTY3JvbGwiLCAib3BlblByZXZpZXciXSk7CiAgfSksIDEyOCkpXSwgMzQpLCBfY3JlYXRlVk5vZGUoX2NvbXBvbmVudF9Gb290ZXIsIHsKICAgIHNlbmRDaGF0OiAkc2V0dXAuc2VuZENoYXQKICB9LCBudWxsLCA4LCBbInNlbmRDaGF0Il0pLCBfd2l0aERpcmVjdGl2ZXMoX2NyZWF0ZVZOb2RlKF9jb21wb25lbnRfUHJldmlldywgewogICAgY2xvc2VQcmV2aWV3OiAkc2V0dXAuY2xvc2VQcmV2aWV3LAogICAgY2xhc3M6IF9ub3JtYWxpemVDbGFzcygkc2V0dXAudGVybWluYWwpLAogICAgdHlwZTogJHNldHVwLnByZXZpZXdJbmZvLnRhZywKICAgIHNyYzogJHNldHVwLnByZXZpZXdJbmZvLnNyYwogIH0sIG51bGwsIDgsIFsiY2xvc2VQcmV2aWV3IiwgImNsYXNzIiwgInR5cGUiLCAic3JjIl0pLCBbW192U2hvdywgJHNldHVwLnByZXZpZXdJbmZvLmlzU2hvd11dKSwgX2NyZWF0ZUVsZW1lbnRWTm9kZSgiZGl2IiwgX2hvaXN0ZWRfMywgW19jcmVhdGVWTm9kZShfVHJhbnNpdGlvbkdyb3VwLCB7CiAgICBuYW1lOiAiYWxlcnQtZmFkZSIsCiAgICB0YWc6ICJBbGVydCIsCiAgICBjbGFzczogInctNzUiCiAgfSwgewogICAgZGVmYXVsdDogX3dpdGhDdHgoKCkgPT4gWyhfb3BlbkJsb2NrKHRydWUpLCBfY3JlYXRlRWxlbWVudEJsb2NrKF9GcmFnbWVudCwgbnVsbCwgX3JlbmRlckxpc3QoJHNldHVwLmFsZXJ0TGlzdCwgKGFsZXJ0Q29uZmlnLCBpbmRleCkgPT4gewogICAgICByZXR1cm4gX29wZW5CbG9jaygpLCBfY3JlYXRlRWxlbWVudEJsb2NrKCJkaXYiLCB7CiAgICAgICAga2V5OiBpbmRleCwKICAgICAgICBjbGFzczogInctMTAwIgogICAgICB9LCBbX2NyZWF0ZVZOb2RlKF9jb21wb25lbnRfQWxlcnQsIHsKICAgICAgICBjbGFzczogX25vcm1hbGl6ZUNsYXNzKGluZGV4KSwKICAgICAgICB0eXBlOiBhbGVydENvbmZpZy50eXBlLAogICAgICAgIG1zZzogYWxlcnRDb25maWcubXNnCiAgICAgIH0sIG51bGwsIDgsIFsiY2xhc3MiLCAidHlwZSIsICJtc2ciXSldKTsKICAgIH0pLCAxMjgpKV0pLAogICAgXzogMQogIH0pXSksICRzZXR1cC5uZXdNZXNzYWdlQ291bnQgPiAwID8gKF9vcGVuQmxvY2soKSwgX2NyZWF0ZUVsZW1lbnRCbG9jaygiZGl2IiwgX2hvaXN0ZWRfNCwgW19jcmVhdGVFbGVtZW50Vk5vZGUoImJ1dHRvbiIsIHsKICAgIGNsYXNzOiAiYnRuIGJ0bi1zbSIsCiAgICBvbkNsaWNrOiBfY2FjaGVbMl0gfHwgKF9jYWNoZVsyXSA9ICguLi5hcmdzKSA9PiAkc2V0dXAuc2Nyb2xsQm90dG9tICYmICRzZXR1cC5zY3JvbGxCb3R0b20oLi4uYXJncykpCiAgfSwgX3RvRGlzcGxheVN0cmluZygkc2V0dXAubmV3TWVzc2FnZUNvdW50KSArICLku7bjga7mlrDopo/jg6Hjg4Pjgrvjg7zjgrgiLCAxKV0pKSA6IF9jcmVhdGVDb21tZW50Vk5vZGUoIiIsIHRydWUpXSldLCA2NCk7Cn0="},{"version":3,"names":["id","class","_createVNode","_Transition","name","$setup","isLoaded","_createElementBlock","_hoisted_1","_component_LoadingSpinner","_createElementVNode","_hoisted_2","_component_Header","ref","block_status","reload","getNewLINEChatData","supportNotification","toggleAutoReload","setBlockFlg","getBlockFlg","_normalizeClass","terminal","onScroll","_cache","args","handleScroll","chatLogs","length","onClick","getOldLINEChatData","_Fragment","_renderList","chat","_createBlock","_component_Balloon","key","chatId","type","speaker","message","url","timestamp","isFirstLoad","isViewDate","contentScroll","openPreview","_component_Footer","sendChat","_component_Preview","closePreview","previewInfo","tag","src","isShow","_hoisted_3","_TransitionGroup","alertList","alertConfig","index","_component_Alert","msg","newMessageCount","_hoisted_4","scrollBottom"],"sources":["C:\\Users\\m.ebisu\\Desktop\\zl_connect\\src\\views\\Main.vue"],"sourcesContent":["<template>\n<transition name=\"fade\">\n  <div v-if=\"!isLoaded\" id=\"loading-window\">\n    <LoadingSpinner/>\n  </div>\n</transition>\n<div class=\"main h-100 w-100 d-flex flex-column\">\n  <Header ref=\"header\" :block_status=\"block_status\" :reload=\"getNewLINEChatData\" :supportNotification=\"supportNotification\" :toggleAutoReload=\"toggleAutoReload\" :setBlockFlg=\"setBlockFlg\" :getBlockFlg=\"getBlockFlg\"></Header>\n  <div class=\"content d-flex flex-column flex-fill border-top border-bottom overflow-auto\" :class=\"terminal\" @scroll=\"handleScroll\">\n    <div :class=\"{'d-none': chatLogs.length == 0}\">\n      <button class=\"btn btn-outline-accent mt-2\" @click=\"getOldLINEChatData\">過去チャットの取得</button>\n    </div>\n    <Balloon\n      ref=\"content\"\n      v-for=\"chat in chatLogs\"\n      v-bind:key=\"chat.chatId\"\n      :chatId=\"chat.chatId\"\n      :type=\"chat.type\"\n      :speaker=\"chat.speaker\"\n      :message=\"chat.message\"\n      :url=\"chat.url\"\n      :timestamp=\"chat.timestamp\"\n      :isFirstLoad=\"chat.isFirstLoad\"\n      :isViewDate=\"chat.isViewDate\"\n      :contentScroll=\"contentScroll\"\n      :openPreview=\"openPreview\"></Balloon>\n  </div>\n  <Footer :sendChat=\"sendChat\"></Footer>\n  <Preview v-show=\"previewInfo.isShow\" :closePreview=\"closePreview\" :class=\"terminal\" :type=\"previewInfo.tag\" :src=\"previewInfo.src\" />\n  <!-- アラート表示 -->\n  <div id=\"alert-wrapper\">\n    <transition-group name=\"alert-fade\" tag=\"Alert\" class=\"w-75\">\n      <div v-for=\"(alertConfig, index) in alertList\" :key=\"index\" class=\"w-100\">\n        <Alert :class=\"index\" :type=\"alertConfig.type\" :msg=\"alertConfig.msg\" />\n      </div>\n    </transition-group>\n  </div>\n  <!-- 新規メッセージ通知 -->\n  <div v-if=\"newMessageCount > 0\" id=\"new-message-button-wrapper\">\n    <button class=\"btn btn-sm\" @click=\"scrollBottom\">{{ newMessageCount }}件の新規メッセージ</button>\n  </div>\n</div>\n</template>\n\n<script>\nimport { ref, reactive, onMounted, onBeforeUnmount, watchEffect } from 'vue';\nimport { useRouter } from 'vue-router';\n\nimport ZohoLINE from '../lib/ZohoLINE.js';\n\nimport Header from '../components/Header.vue';\nimport Balloon from '../components/Balloon.vue';\nimport Footer from '../components/Footer.vue';\n\nimport Preview from '../components/Preview.vue';\nimport LoadingSpinner from '../components/LoadingSpinner.vue';\nimport Alert from '../components/Alert.vue';\n\nimport dayjs from 'dayjs';\nimport 'dayjs/locale/ja';\ndayjs.locale('ja');\n\nexport default {\n  name: 'Main',\n  components: {\n    Header,\n    Balloon,\n    Footer,\n    LoadingSpinner,\n    Preview,\n    Alert\n  },\n  setup() {\n    console.log(\"setup\");\n    const USER_TYPE_OBJ = {\n      0: \"right\",\n      1: \"left\"\n    };\n    const CHAT_TYPE_OBJ = {\n      0: \"text\",\n      1: \"sticker\",     // スタンプ\n      2: \"image\",       // 画像\n      3: \"video\",       // 動画\n      4: \"audio\",       // 音声\n      5: \"application\"  // PDF\n    };\n    const AUTO_RELOAD_INTERVAL = 1 * 1000;\n    // ZohoLINEクラス\n    let ZLC = null;\n    // Zohoプラグイン\n    const ZOHO = window.ZOHO;\n    // vue-router\n    const router = useRouter();\n    // 読み込みフラグ\n    const isLoaded = ref(false);\n    // Zoho CRMログインユーザーデータ\n    const currentUser = ref(\"\");\n    // Zohoレコードデータ\n    const lineUserData = ref(\"\");\n    // 顧客ID\n    const lineUserId = ref(\"\");\n    // LINEチャットログ\n    const chatLogs = ref([]);\n    //LINE既読時間\n    const last_read_time = ref(\"0\");\n    //取得した一番古いLINEチャットの時間\n    const oldest_chat_time = ref(dayjs().format(\"YYYY-MM-DD HH:mm:ss.SSS\"));\n    // ZohoLINEの契約企業ID\n    const companyId = ref('');\n    // ZohoLINEのチャンネルID\n    const channelId = ref('');\n    // ZohoLINEのAPIキー\n    const apiKey = ref('');\n    //ヘッダーのDOM\n    const header = ref(null);\n    //チャット表示エリアのDOM\n    const content = ref(null);\n    //チャット表示エリアのスクロール位置\n    const contentScrollPosition = ref(null);\n    //スクロール位置が一番下であるか\n    const isBottomScrollPosition = ref(null);\n    // 最初のチャットデータ取得フラグ\n    const isFirstGetChatData = ref(true);\n    // 自動更新を行うsetIntervalのID\n    const autoReloadId = ref(null);\n    // 自動更新の自動停止時間(自動更新開始から６時間後に自動停止) dayjsオブジェクト\n    const autoReloadLimitTime = ref(null);\n    // 端末の識別用変数\n    const terminal = ref(\"pc\");\n    // アラート表示用変数\n    const alertList = ref([]);\n    // コンテンツプレビュー用変数\n    const previewInfo = reactive({\n      isShow: false,\n      tag: \"img\",\n      src: \"\"\n    });\n    // 新規メッセージ未表示件数\n    const newMessageCount = ref(0);\n    // ブロックフラグ\n    const block_status = ref(false);\n\n    watchEffect(\n      () => {\n        contentScroll();\n      },\n      {\n        flush: 'post'\n      }\n    );\n\n    onMounted(async () => {\n      console.log(\"onMounted\");\n      const appElement = document.getElementById(\"app\");\n      getTerminal();\n      window.addEventListener('resize', getTerminal);\n      //Zohoプラグインの初期化完了時\n      ZOHO.embeddedApp.on(\"PageLoad\", (data) => {\n        appElement.classList.add('loaded');\n        appElement.dataset.entity = data.Entity;\n        appElement.dataset.entityId = data.EntityId;\n        // ZohoLINEの必要なデータの取得\n        initialize(data);\n      });\n      //Zohoプラグインの初期化\n      ZOHO.embeddedApp.init();\n      if(appElement.classList.contains('loaded')){\n        initialize({\n          Entity: appElement.dataset.entity,\n          EntityId: appElement.dataset.entityId\n        });\n      }\n    });\n\n    onBeforeUnmount(() => {\n      console.log(\"onBeforeUnmount\")\n      if(autoReloadId.value != null){\n        clearTimeout(autoReloadId.value);\n        autoReloadId.value = null;\n      }\n      window.removeEventListener('resize', getTerminal);\n    });\n\n    const initialize = async (data) => {\n      try {\n        isFirstGetChatData.value = true;\n        //LINEユーザーデータの取得\n        lineUserData.value = await getZohoCustomerId(data.Entity, data.EntityId);\n        lineUserId.value = lineUserData.value.LINE_ID;\n        // ZohoLINEのAPIキーの取得\n        const zohoLineConfig = await getZohoCRMVariables({apiKeys:[\"zoho_line_api_key\", \"zoho_line_company_id\", \"zoho_line_channel_id\"]});\n        if(zohoLineConfig.zoho_line_company_id.value){\n          companyId.value = zohoLineConfig.zoho_line_company_id.value;\n        }else{\n          throw new Error(\"契約企業IDが見つかりませんでした\");\n        }\n        if(zohoLineConfig.zoho_line_api_key.value){\n          apiKey.value = zohoLineConfig.zoho_line_api_key.value;\n        }else{\n          throw new Error(\"ZohoLINE APIキーが見つかりませんでした\");\n        }\n        if(zohoLineConfig.zoho_line_channel_id.value){\n          channelId.value = zohoLineConfig.zoho_line_channel_id.value;\n        }else{\n          throw new Error(\"ZohoLINE チャンネルIDが見つかりませんでした\");\n        }\n        ZLC = new ZohoLINE(companyId.value, channelId.value, apiKey.value);\n        // ブロックステータスの取得\n        const userData = await ZLC.getBlockFlg(lineUserId.value);\n        block_status.value = userData.block_status;\n        console.log(\"ブロックステータス：\",block_status.value);\n        currentUser.value = await getCurrentUser();\n        await supportNotification(\"start\");\n        toggleAutoReload(false);\n        toggleAutoReload(true);\n        isLoaded.value = true;\n      } catch (err) {\n        console.error(err);\n        router.push({name: 'Error', params: { message: err.message }});\n      }\n    };\n\n    const sendChat = async (message, type, file=null) => {\n      // メッセージ送信\n      if (type == \"text\") {\n        await ZLC.sendChat(lineUserId.value, message).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"メッセージの送信に失敗しました\");\n          }\n        });\n      // スタンプ送信\n      }else if(type == \"sticker\"){\n        await ZLC.sendStickerChat(lineUserId.value, message).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"スタンプの送信に失敗しました\");\n          }\n        });\n      // 画像送信\n      }else if(type == \"image\"){\n        await ZLC.sendImageChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"画像の送信に失敗しました\");\n          }\n        });\n      // 動画送信\n      }else if(type == \"video\"){\n        await ZLC.sendVideoChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"動画の送信に失敗しました\");\n          }\n        });\n      // 音声送信\n      }else if(type == \"audio\"){\n        await ZLC.sendAudioChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"音声の送信に失敗しました\");\n          }\n        });\n      // PDF送信\n      }else if(type == \"application\"){\n        await ZLC.sendPdfChat(lineUserId.value, file).catch((err) => {\n          console.error(err);\n          if(err.responseJSON.type == \"Remaining\" ){\n            showAlert(\"danger\", \"送信上限数を超えたため、送信に失敗しました。\");\n          } else {\n            showAlert(\"danger\", \"PDFの送信に失敗しました\");\n          }\n        });\n      }\n      isBottomScrollPosition.value = null;\n      // await getNewLINEChatData();\n    };\n\n    // LINE連携済みの顧客IDの取得\n    const getZohoCustomerId = (entity, recordId) => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.API.getRecord({\n          Entity: entity,\n          RecordID: recordId\n        }).then((response) => {\n          // console.log(response);\n          if (response.data && response.data[0]) {\n            resolve(response.data[0]);\n          } else {\n            reject();\n          }\n        }).catch((err) => {\n          reject(err);\n        });\n      });\n    };\n\n    //CRMの変数からZohoLINEのAPIキーを取得\n    const getZohoCRMVariables = (apiName) => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.API.getOrgVariable(apiName).then((response) => {\n          console.log(response);\n          if (response.Success) {\n            resolve(response.Success.Content);\n          } else {\n            reject(response);\n          }\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    // ログインユーザーデータの取得\n    const getCurrentUser = () => {\n      return new Promise((resolve, reject) => {\n        ZOHO.CRM.CONFIG.getCurrentUser().then((response) => {\n          try{\n            resolve(response.users[0]);\n          }catch(err){\n            console.error(err);\n            reject(err);\n          }\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    const supportNotification = (type) => {\n      return new Promise((resolve, reject) => {\n        const functionName = \"supportnotification\";\n        const requestData = {\n          arguments: JSON.stringify({\n            type: type,\n            currentUserName: currentUser.value.full_name,\n            contactName: lineUserData.value.Full_Name,\n            contactId: lineUserData.value.id\n          })\n        };\n        ZOHO.CRM.FUNCTIONS.execute(functionName, requestData).then(function(response){\n          resolve(response);\n        }).catch((err) => {\n          console.error(err);\n          reject(err);\n        });\n      });\n    };\n\n    // LINEチャットデータの取得\n    const getLINEChatData = async () => {\n      const lineChatData = await ZLC.getChat(lineUserId.value);\n      // console.log(lineChatData)\n      let lineChatArray = [];\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 1){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n\n        lineChatArray.push({\n          chatId: chat.chat_id,\n          speaker: USER_TYPE_OBJ[chat.user_type],\n          type: CHAT_TYPE_OBJ[chat.chat_type],\n          message: chat.text,\n          // url: chat.media_url ? ZLC.getMediaURL(chat.media_url) : null,\n          // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n          url: url,\n          timestamp: chat.sent_at,\n          isFirstLoad: true\n        });\n        console.log(\"LINE取得\");\n        console.log(chat.sent_at);\n        updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n    };\n    // 新規LINEチャットデータの取得\n    const getNewLINEChatData = async () => {\n      const lineChatData = await ZLC.getNewChat(lineUserId.value, last_read_time.value);\n      let lineChatArray = chatLogs.value;\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 1){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n          lineChatArray.push({\n            chatId: chat.chat_id,\n            speaker: USER_TYPE_OBJ[chat.user_type],\n            type: CHAT_TYPE_OBJ[chat.chat_type],\n            message: chat.text,\n            // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n            url: url,\n            timestamp: chat.sent_at,\n            isFirstLoad: false\n          });\n          console.log(\"新規LINE取得\");\n          console.log(chat.sent_at);\n          updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n      if(isBottomScrollPosition.value === false){\n        newMessageCount.value = newMessageCount.value + lineChatData.chats.length;\n      }else{\n        newMessageCount.value = 0;\n      }\n    };\n    // 過去LINEチャットデータの取得\n    const getOldLINEChatData = async () => {\n      // チャット取得前のチャット表示エリアの高さを保存\n      contentScrollPosition.value = content.value.$el.parentElement.scrollHeight;\n      // console.log(\"getOldLINEChatData\", contentScrollPosition.value)\n      const lineChatData = await ZLC.getOldChat(lineUserId.value, oldest_chat_time.value, 10);\n      let lineChatArray = chatLogs.value;\n      for (let chat of lineChatData.chats) {\n        let url = null;\n        if(chat.media_url){\n          // スタンプの場合はアドレスをそのまま指定\n          if(chat.chat_type == 4){\n              url = chat.media_url;\n          // スタンプ以外の場合はS3のパスを取得し指定\n          } else {\n              // url = ZLC.getMedia(chat.media_url)\n              url = ZLC.getMedia(chat.chat_id);\n          }\n        }\n        lineChatArray.push({\n          chatId: chat.chat_id,\n          speaker: USER_TYPE_OBJ[chat.user_type],\n          type: CHAT_TYPE_OBJ[chat.chat_type],\n          message: chat.text,\n          // url: chat.media_url ? ZLC.getMedia(chat.media_url) : null,\n          url: url,\n          timestamp: chat.sent_at,\n          isFirstLoad: false\n        });\n        console.log(\"過去LINE取得\");\n        console.log(chat.sent_at);\n        updateChatReadTime(chat.sent_at);\n      }\n      updateChatLogs(lineChatArray);\n    };\n\n    const toggleAutoReload = (isAutoReload) => {\n      console.log(\"toggleAutoReload\");\n      if(isAutoReload && autoReloadId.value == null){\n        // 6時間後に自動更新をオフ\n        autoReloadLimitTime.value = dayjs().add(6, 'h');\n        autoReloadId.value = setInterval(async () => {\n          if(isFirstGetChatData.value){\n            isFirstGetChatData.value = false;\n            await getLINEChatData();\n          }else if(dayjs().isBefore(autoReloadLimitTime.value)){\n            await getNewLINEChatData();\n          }else{\n            header.value.stopAutoReload();\n          }\n        }, AUTO_RELOAD_INTERVAL);\n      }else if(!isAutoReload && autoReloadId.value != null){\n        clearTimeout(autoReloadId.value);\n        autoReloadId.value = null;\n        autoReloadLimitTime.value = null;\n      }\n    };\n    // チャット表示エリアのスクロールハンドル\n    const handleScroll = () => {\n      const target = content.value.$el.parentElement;\n      contentScrollPosition.value = null;\n      if(target.scrollTop + target.clientHeight  == target.scrollHeight){\n        isBottomScrollPosition.value = true;\n        newMessageCount.value = 0;\n      }else{\n        isBottomScrollPosition.value = false;\n      }\n    };\n\n    // chatLogsの更新\n    const updateChatLogs = (lineChatArray) => {\n      chatLogs.value = lineChatArray.sort((x, y) => {\n        if (x.chatId < y.chatId) return -1;\n        if (x.chatId > y.chatId) return 1;\n        return 0;\n      });\n      let sentDate = dayjs(0);\n      chatLogs.value.forEach((chatLog, i) => {\n        if(sentDate.isBefore( dayjs(chatLogs.value[i].timestamp.split(\" \")[0], \"YYYY-MM-DD\"))){\n          sentDate = dayjs(chatLogs.value[i].timestamp.split(\" \")[0], \"YYYY-MM-DD\");\n          chatLogs.value[i].isViewDate = true;\n        }else{\n          chatLogs.value[i].isViewDate = false;\n        }\n      });\n      // console.log(chatLogs)\n    };\n\n    // 新規チャット、過去チャット取得のための時間の更新\n    const updateChatReadTime = (sent_at) => {\n      if (dayjs(oldest_chat_time.value, \"YYYY-MM-DD HH:mm:ss.SSS\").isAfter(dayjs(sent_at, \"YYYY-MM-DD HH:mm:ss.SSS\"))) {\n        oldest_chat_time.value = sent_at;\n      }\n      if (dayjs(last_read_time.value, \"YYYY-MM-DD HH:mm:ss.SSS\").isBefore(dayjs(sent_at, \"YYYY-MM-DD HH:mm:ss.SSS\"))) {\n        last_read_time.value = sent_at;\n      }\n      console.log(oldest_chat_time.value)\n    };\n\n    // LINEチャット表示エリアの自動スクロール\n    // -過去のチャット読み込み時はスクロール位置固定\n    // -最新チャット読み込み時は一番下までスクロール\n    const contentScroll = (isFirstLoad=false) => {\n      if(content.value){\n        const target = content.value.$el.parentElement;\n        setTimeout(() => {\n          if(isFirstLoad){\n            target.scrollTop = target.scrollHeight;\n          }else if(contentScrollPosition.value != null){\n            target.scrollTop = target.scrollHeight - contentScrollPosition.value;\n          }else if(isBottomScrollPosition.value == null || isBottomScrollPosition.value == true){\n            target.scrollTop = target.scrollHeight;\n          }\n        }, 0);\n      }\n    };\n\n    const getTerminal = () => {\n      if(window.outerWidth > window.outerHeight){\n        terminal.value = \"pc\";\n      }else{\n        terminal.value = \"sp\"\n      }\n    };\n\n    const openPreview = (tag, src) => {\n      previewInfo.isShow = true;\n      previewInfo.tag = tag;\n      previewInfo.src = src;\n    };\n\n    const closePreview = () => {\n      previewInfo.isShow = false;\n    };\n\n    const showAlert = (type, msg) => {\n      if(type){\n        alertList.value.push({\n          type: type,\n          msg: msg\n        });\n        setTimeout(function () {\n          alertList.value.shift();\n        }, 2500);\n      }\n    };\n\n    const scrollBottom = () => {\n      if(content.value){\n        const target = content.value.$el.parentElement;\n        target.scrollTop = target.scrollHeight;\n      }\n    };\n\n    const getBlockFlg = async () => {\n      console.log(lineUserId.value);\n      return await ZLC.getBlockFlg(lineUserId.value).catch((err) => {\n          console.error(err);\n      });\n    }\n\n    const setBlockFlg = async () => {\n        console.log(lineUserId.value);\n        block_status.value = !block_status.value;\n        console.log(\"ブロックステータス：\",block_status.value);\n        await ZLC.setBlockFlg(lineUserId.value, block_status.value).catch((err) => {\n          console.error(err);\n        });\n        if(block_status.value){\n          showAlert(\"success\", \"ブロックしました。\");\n        } else {\n          showAlert(\"success\", \"ブロック解除しました。\");\n        }\n    };\n    return {\n      header,\n      content,\n      chatLogs,\n      sendChat,\n      getNewLINEChatData,\n      getOldLINEChatData,\n      toggleAutoReload,\n      contentScroll,\n      handleScroll,\n      isLoaded,\n      terminal,\n      previewInfo,\n      openPreview,\n      closePreview,\n      alertList,\n      showAlert,\n      supportNotification,\n      newMessageCount,\n      scrollBottom,\n      block_status,\n      getBlockFlg,\n      setBlockFlg\n    };\n  }\n}\n</script>\n<style scoped>\n#loading-window {\n  display: flex;\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  justify-content: center;\n  align-items: center;\n  background-color: white;\n  z-index: 9999;\n}\n.fade-enter-active,\n.fade-leave-active {\n  transition: opacity 0.5s ease;\n}\n\n.fade-enter-from,\n.fade-leave-to {\n  opacity: 0;\n}\n.content {\n  background-color: #b0d2ff;\n}\n.alert-fade-enter-active,\n.alert-fade-leave-active {\n  transition: opacity 0.2s ease;\n}\n\n.alert-fade-enter-from,\n.alert-fade-leave-to {\n  opacity: 0;\n}\n#alert-wrapper{\n  width: 100%;\n  max-height: 80%;\n  position: absolute;\n  top: 55px;\n  display: flex;\n  justify-content: center;\n  overflow: hidden;\n  pointer-events: none;\n}\n#new-message-button-wrapper {\n  position: absolute;\n  bottom: 55px;\n  display: flex;\n  justify-content: center;\n  left: 0;\n  right: 0;\n  pointer-events: none;\n}\n#new-message-button-wrapper button {\n  color: #ffffff;\n  background-color: #00000099;\n  pointer-events: auto;\n}\n</style>\n"],"mappings":"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","ignoreList":[]}]}